<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Tree 1</title>

    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://rawgit.com/blairmacintyre/aframe-look-at-billboard-component/master/dist/aframe-look-at-billboard-component.min.js"></script>
</head>

<body style="margin: 10; overflow: hidden;">

    <!-- Back Button UI -->
    <div style="position: fixed; top:80%; width:100%; text-align: center; z-index: 1;">
        <img src="./media/back button.png" width="80" height="80">
        <button id="Back"></button>
    </div>

    <!-- AR Scene -->
    <a-scene
        cursor="rayOrigin: mouse; fuse: true; fuseTimeout: 0;"
        raycaster="objects: [clickhandler];"
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
    >

        <!-- GPS Debug HUD -->
        <a-entity id="gpsDebug" position="0 2 -3">
            <a-text id="gpsText"
                    value="Waiting for GPS..."
                    color="yellow"
                    align="center"
                    width="4">
            </a-text>
        </a-entity>

       
        <!-- Camera -->
        <a-camera
            look-controls-enabled="false"
            arjs-look-controls="smoothingFactor: 0.1"
            gps-camera="minDistance: 1; maxDistance: 2000; positionMinAccuracy: 20;"
            rotation-reader>
        </a-camera>

    </a-scene>

    <script>
        document.querySelector("#Back").addEventListener("click", function () {
            window.history.back();
        });

        // GPS Debug Overlay Logic
        document.addEventListener("gps-camera-update-position", e => {
            const lat = e.detail.position.latitude;
            const lon = e.detail.position.longitude;
            const acc = e.detail.position.accuracy;

            // Tree coordinates
            const tree4 = { lat: -33.9149819, lon: 151.0366839 };
            const tree5 = { lat: -33.91511468, lon: 151.0366889 };

            function distanceTo(lat1, lon1, lat2, lon2) {
                const R = 6371000; // meters
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a =
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI/180) *
                    Math.cos(lat2 * Math.PI/180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);

                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }

            const dist4 = distanceTo(lat, lon, tree4.lat, tree4.lon).toFixed(1);
            const dist5 = distanceTo(lat, lon, tree5.lat, tree5.lon).toFixed(1);

            const debugText = `
Lat: ${lat.toFixed(6)}
Lon: ${lon.toFixed(6)}
Accuracy: ${acc}m

Tree4: ${dist4}m away
Tree5: ${dist5}m away
            `;

            document.querySelector("#gpsText").setAttribute("value", debugText);
        });
    </script>

</body>
</html>
